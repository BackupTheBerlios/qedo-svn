#include "GeneratorMakefile.h"
#include "Debug.h"
#include <string>


#ifdef _WIN32
#include <direct.h>
#include <Windows.h>
#include <objbase.h>
#else
#include "sys/stat.h"
#endif


namespace QEDO_CIDL_Generator {


GeneratorMakefile::GeneratorMakefile
( QEDO_ComponentRepository::CIDLRepository_impl *repository)
: CPPBase(repository), uid_(0)
{
}


GeneratorMakefile::~GeneratorMakefile
()
{
}

void
GeneratorMakefile::generate(std::string target, std::string fileprefix)
{
	try { initialize(target, fileprefix); }
	catch (InitializeError) { return; }

	doGenerate();
	generateServant();
}


//
// module
//
void
GeneratorMakefile::doModule(IR__::ModuleDef_ptr module)
{
	// contained modules
	handleModule(module);

	// contained compositions
	handleComposition(repository_);
}

//
// composition
//
void
GeneratorMakefile::doComposition(CIDL::CompositionDef_ptr composition)
{
	//
	// build file name for executor project and open file
	//
	std::string id = composition->id();
	std::string project_name;
	std::string servant_project_name;
	std::string composition_name;
	IR__::Contained_ptr module_def = 0;
	std::string::size_type pos = id.find_last_of("/");
	if(pos != std::string::npos)
	{
		id.replace(pos, std::string::npos, ":1.0");
		module_def = repository_->lookup_id(id.c_str());
		composition_name = getAbsoluteName(module_def, "_");
		composition_name.append("_");
	}
	composition_name.append(composition->name());
	project_name = composition_name;
	servant_project_name = composition_name + "_SERVANT";

#ifdef WIN32
	_mkdir(project_name.c_str());
#else
	mkdir(project_name.c_str(), 0755);
#endif
	filename_ = project_name + "/Makefile";
	out.open(filename_.c_str());

	out << "ORB_IDL_INCLUDE = -I..\n\n";

	out << "CIDL_FILES = ../" << target_file_name_ << "\n\n";
	out << "IDL_FILES = " << composition_name << "_LOCAL.idl \\\n";
	out << "\t" << composition_name << "_EQUIVALENT.idl \\\n";
	out << "\t" << composition_name << "_BUSINESS.idl \n\n";

	out << "CPP_FILES = " << composition_name << "_BUSINESS.cpp \\\n";
//	out << "\t" << composition_name << "_EQUIVALENT.cpp \\\n";
//	out << "\t" << composition_name << "_LOCAL.cpp \\\n";
	out << "\t" << composition_name << ".cpp \\\n";
	out << "\tvaluetypes.cpp \n\n";


	out << "OBJ_FILES = ${CPP_FILES:%.cpp=%.o} \n\n";

	out << "LIBS += -L../" << composition_name << "_SERVANT -l";
	out << composition_name << "_SERVANT \n\n";

	out << "CXXFLAGS += -I. -g\n\n";

	out << "include ../MakeComponentVars\n\n";

	out << "all: lib" << composition_name << ".so \n\n";

	out << "lib" << composition_name << ".so: ${OBJ_FILES} \n\n";

	out << "${IDL_FILES} valuetypes.cpp : ${CIDL_FILES} \n";
	out << "\t${CIDL_GEN} -I${QEDO}/idl -I${ORB_IDL_INCLUDE} ${CIDL_ORB_DEF} \\\n";
	out << "\t--business --target \"" << composition->id() << "\" $< \n\n";

	out << composition_name << "_BUSINESS.cpp: " << composition_name << "_EQUIVALENT.h ";
	out << composition_name << "_LOCAL.h \n\n";

	
}




/**
 *
 */
void
GeneratorMakefile::generateServant()
{
}

} // namespace
