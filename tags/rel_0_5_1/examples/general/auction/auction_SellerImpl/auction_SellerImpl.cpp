//
// generated by Qedo
//

#include "auction_SellerImpl.h"


// BEGIN USER INSERT SECTION file
// END USER INSERT SECTION file


namespace auction {


// BEGIN USER INSERT SECTION SellerSessionImpl
void*
SellerSessionImpl::run(void *p)
{
	SellerSessionImpl* impl;

	impl = static_cast<SellerSessionImpl*>(p);

	std::string item;
	unsigned long minimum;

	while (! impl->stopped)
	{
		std::cout << "Yout have " << impl->seller_amount << " money" << std::endl;
		std::cout << "Give a item for sell" << std::endl;
		std::cout << "Item name:" ;
		std::cin >> item;
		if (impl->stopped) break;
		std::cout << "Item minimum price:" ;
		std::cin >> minimum;
		if (impl->stopped) break;
		impl->do_sell(item.c_str(),minimum);
		impl->seller_mutex->lock();
		impl->seller_cond->wait(impl->seller_mutex);
		impl->seller_mutex->unlock();
	};

	return 0;
}

void
SellerSessionImpl::stop()
{
	stopped = true;
	seller_cond->signal();
	seller_thread->join();
}

void
SellerSessionImpl::do_sell(const char* item, unsigned long minimum)
{
	CORBA::Object_ptr obj;
	auction::SellerForAuctioneer_var me;
	CORBA::Long contract;

	obj = context_->get_CCM_object();

	me = auction::SellerForAuctioneer::_narrow(obj);

	contract = context_->get_connection_from_auctioneer()->sell(me,item,minimum);

	std::cout << "Got contract " << contract << " for item '" << item << "'" << std::endl;
}
// END USER INSERT SECTION SellerSessionImpl


SellerSessionImpl::SellerSessionImpl()
{
// BEGIN USER INSERT SECTION SellerSessionImpl::SellerSessionImpl
	stopped = false;
	seller_amount = 0;
// END USER INSERT SECTION SellerSessionImpl::SellerSessionImpl
}


SellerSessionImpl::~SellerSessionImpl()
{
// BEGIN USER INSERT SECTION SellerSessionImpl::~SellerSessionImpl
// END USER INSERT SECTION SellerSessionImpl::~SellerSessionImpl

}


void
SellerSessionImpl::set_context(::auction::CCM_Seller_ContextImpl_ptr context)
    throw (CORBA::SystemException, Components::CCMException)
{
    context_ = ::auction::CCM_Seller_ContextImpl::_duplicate(context);
}


void
SellerSessionImpl::configuration_complete()
    throw (CORBA::SystemException, Components::InvalidConfiguration)
{
// BEGIN USER INSERT SECTION SellerSessionImpl::configuration_complete
	seller_mutex = context_->create_mutex();
	seller_cond = context_->create_cond();
	seller_thread = context_->start_thread(run,this);
// END USER INSERT SECTION SellerSessionImpl::configuration_complete
}


void
SellerSessionImpl::remove()
    throw (CORBA::SystemException)
{
// BEGIN USER INSERT SECTION SellerSessionImpl::remove
// END USER INSERT SECTION SellerSessionImpl::remove
}


void
SellerSessionImpl::amount(CORBA::Long param)
	throw(CORBA::SystemException)
{
// BEGIN USER INSERT SECTION SellerSessionImpl::_amount
	seller_amount = param;
// END USER INSERT SECTION SellerSessionImpl::_amount
}


CORBA::Long
SellerSessionImpl::amount()
	throw(CORBA::SystemException)
{
// BEGIN USER INSERT SECTION SellerSessionImpl::amount
	return seller_amount;
// END USER INSERT SECTION SellerSessionImpl::amount
}


void
SellerSessionImpl::pay(CORBA::Long cnt, CORBA::Long amount)
	throw(CORBA::SystemException)
{
// BEGIN USER INSERT SECTION SellerSessionImpl::pay
	std::cout << "Got payment " << amount << "for contract " << cnt << std::endl;
	seller_amount = seller_amount + amount;
	seller_cond->signal();
// END USER INSERT SECTION SellerSessionImpl::pay
}


// BEGIN USER INSERT SECTION SellerImpl
// END USER INSERT SECTION SellerImpl


SellerImpl::SellerImpl()
:component_(new SellerSessionImpl())
{
// BEGIN USER INSERT SECTION SellerImpl::SellerImpl
// END USER INSERT SECTION SellerImpl::SellerImpl
}


SellerImpl::~SellerImpl()
{
// BEGIN USER INSERT SECTION SellerImpl::~SellerImpl
// END USER INSERT SECTION SellerImpl::~SellerImpl

    component_->_remove_ref();
}


::CORBA::Object*
SellerImpl::obtain_executor(const char* name)
    throw (CORBA::SystemException)
{
    if (! strcmp ( name, "component" ) ) {
        return Components::EnterpriseComponent::_duplicate (component_);
    }
    
    return Components::EnterpriseComponent::_nil();
}


void
SellerImpl::release_executor(::CORBA::Object_ptr executor)
    throw (CORBA::SystemException)
{
    CORBA::release (executor);
}


void
SellerImpl::configuration_complete()
    throw (CORBA::SystemException, Components::InvalidConfiguration)
{
    component_->configuration_complete();

// BEGIN USER INSERT SECTION SellerImpl::configuration_complete
// END USER INSERT SECTION SellerImpl::configuration_complete
}


void
SellerImpl::set_session_context(::Components::SessionContext_ptr context)
    throw (CORBA::SystemException, Components::CCMException)
{
    #ifdef TAO_ORB
    ::auction::CCM_Seller_Context_ptr tmp_context;
    
    tmp_context = dynamic_cast<::auction::CCM_Seller_ContextImpl*>(context);
    
    if (tmp_context)
        context_ = ::auction::CCM_Seller_ContextImpl::_duplicate(tmp_context);
    else
        context_ = ::auction::CCM_Seller_ContextImpl::_nil();
        
    #else
    context_ = ::auction::CCM_Seller_ContextImpl::_narrow(context);
    
    #endif
    component_->set_context(context_);
}


void
SellerImpl::ccm_activate()
    throw (CORBA::SystemException, Components::CCMException)
{
// BEGIN USER INSERT SECTION SellerImpl::ccm_activate
// END USER INSERT SECTION SellerImpl::ccm_activate
}


void
SellerImpl::ccm_passivate()
    throw (CORBA::SystemException, Components::CCMException)
{
// BEGIN USER INSERT SECTION SellerImpl::ccm_passivate
// END USER INSERT SECTION SellerImpl::ccm_passivate
}


void
SellerImpl::ccm_remove()
    throw (CORBA::SystemException, Components::CCMException)
{
// BEGIN USER INSERT SECTION SellerImpl::ccm_remove
	std::cout << "SellerImpl: ccm_remove() called" << std::endl;
	component_->stop();
// END USER INSERT SECTION SellerImpl::ccm_remove
}


// BEGIN USER INSERT SECTION SellerHomeImpl
// END USER INSERT SECTION SellerHomeImpl


SellerHomeImpl::SellerHomeImpl()
{
// BEGIN USER INSERT SECTION SellerHomeImpl::SellerHomeImpl
// END USER INSERT SECTION SellerHomeImpl::SellerHomeImpl
}


SellerHomeImpl::~SellerHomeImpl()
{
// BEGIN USER INSERT SECTION SellerHomeImpl::~SellerHomeImpl
// END USER INSERT SECTION SellerHomeImpl::~SellerHomeImpl

}


void
SellerHomeImpl::set_context(Components::HomeContext_ptr ctx)
    throw (CORBA::SystemException, Components::CCMException)
{
    context_ = Components::HomeContext::_duplicate(ctx);
}


::Components::EnterpriseComponent_ptr
SellerHomeImpl::create ()
    throw (CORBA::SystemException, Components::CreateFailure)
{
// BEGIN USER INSERT SECTION SellerHomeImpl::create
// END USER INSERT SECTION SellerHomeImpl::create
    return new SellerImpl();
}


};


//
// entry point
//
::Components::HomeExecutorBase_ptr
create_SellersE(void)
{
// BEGIN USER INSERT SECTION create_Sellers
// END USER INSERT SECTION create_Sellers

    return new ::auction::SellerHomeImpl();
}

